*&---------------------------------------------------------------------*
*& Report ZS0114
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zs0114.
TABLES : with_item ,acdoca,t001w, bkpf .

INCLUDE zinclude_s0114_ss.
INCLUDE Zinclude_s0114_top.



START-OF-SELECTION.
  SELECT bukrs belnr witht wt_withcd wt_amnman wt_qsshh qsatz wt_qbshh wt_acco wt_wtexmn GJAHR
    INTO TABLE it_wit
    FROM with_item
    WHERE bukrs IN s_bukrs  and gjahr in s_gjahr.

    IF it_wit IS NOT INITIAL.
      SELECT rbukrs prctr belnr gjahr
        INTO TABLE it_ACDOCA
        FROM acdoca
        FOR ALL ENTRIES IN it_wit
        WHERE rbukrs = it_wit-bukrs  AND belnr = it_wit-belnr.

    ENDIF.

  IF it_acdoca IS NOT INITIAL.
    SELECT werks name1
      INTO TABLE it_t001w
      FROM t001w
      FOR ALL ENTRIES IN it_acdoca
      WHERE werks = it_acdoca-prctr+0(4).

  ENDIF.
  IF it_wit IS NOT INITIAL.
    SELECT bukrs belnr gjahr bldat cpudt blart budat
      INTO TABLE it_bkpf
      FROM bkpf
      FOR ALL ENTRIES IN it_wit
      WHERE  belnr = it_wit-belnr
      and bukrs = it_wit-bukrs AND bukrs in s_bukrs
      and gjahr = it_wit-gjahr AND gjahr in s_gjahr
      and bldat in s_bldat .
  ENDIF.

  IF it_wit IS NOT INITIAL.
    SELECT witht wt_withcd qscod
      INTO TABLE it_t059z
      FROM t059z
      FOR ALL ENTRIES IN it_wit
      WHERE witht = it_wit-witht  AND wt_withcd = it_wit-wt_withcd .
  ENDIF.

  IF  it_t059z IS NOT INITIAL.
    SELECT land1 witht rctxt
     INTO TABLE it_T059D
      FROM t059d
      FOR ALL ENTRIES IN it_t059z
      WHERE witht = it_t059z-witht.
  ENDIF.

  IF it_wit IS NOT INITIAL.
    SELECT land1 j_1ipanno lifnr adrnr stras regio
      INTO TABLE it_lfa1
      FROM lfa1
      FOR ALL ENTRIES IN it_wit
      WHERE lifnr = it_wit-wt_acco.
  ENDIF.

  IF it_lfa1 IS NOT INITIAL.
    SELECT partner  name_org1 name_org2 name_org3
      INTO TABLE it_but000
      FROM but000
      FOR ALL ENTRIES IN it_lfa1
      WHERE partner = it_lfa1-lifnr.
  ENDIF.
  IF it_lfa1 IS NOT INITIAL.
    SELECT addrnumber str_suppl1 str_suppl2 str_suppl3 street post_code1
      INTO TABLE it_adrc
      FROM adrc
      FOR ALL ENTRIES IN it_lfa1
      WHERE addrnumber = it_lfa1-adrnr.
  ENDIF.
  IF it_lfa1 IS NOT INITIAL.
    SELECT bland bezei
      INTO TABLE it_t005u
      FROM t005u
      FOR ALL ENTRIES IN it_lfa1
      WHERE bland = it_lfa1-regio.
  ENDIF.
  IF it_lfa1 IS NOT INITIAL.
    SELECT addrnumber smtp_srch
      INTO TABLE it_adr6
      FROM adr6
      FOR ALL ENTRIES IN it_lfa1
      WHERE addrnumber = it_lfa1-adrnr.

  ENDIF.

END-OF-SELECTION.


  LOOP AT it_wit INTO wa_wit.
    wa_final-bukrs = wa_wit-bukrs.
    wa_final-belnr  = wa_wit-belnr.
    wa_final-reason  = wa_wit-wt_wtexmn.
    wa_final-certificatenumber  = wa_wit-wt_wtexmn.

    CASE wa_wit-wt_amnman.
      WHEN 'X'.
        wa_final-lv_RATEATWHICHTAXDEDUCTED = Wa_wit-wt_qbshh / Wa_wit-wt_qsshh * 100.
      WHEN OTHERS.
        wa_final-lv_RATEATWHICHTAXDEDUCTED = wa_wit-qsatz.
    ENDCASE.

    READ TABLE it_acdoca INTO wa_acdoca WITH  KEY wa_wit-bukrs.
    wa_final-lv_plant = wa_acdoca-prctr+0(4).

    READ TABLE it_t001w INTO wa_t001w WITH KEY wa_acdoca-prctr+0(4).
    wa_final-name1 = wa_t001w-name1.

    READ TABLE it_bkpf INTO wa_bkpf WITH  KEY wa_wit-bukrs .
    CASE wa_bkpf-blart.
      WHEN 'KZ' OR 'KB' OR 'ZP'.
        wa_final-lv_AMOUNTOFPAYMENT = wa_wit-wt_qsshh.
      WHEN OTHERS.
        wa_final-lv_AMOUNTOFPAYMENT = wa_wit-wt_qsshh * 1.
    ENDCASE.

    CASE wa_bkpf-blart.
      WHEN 'KZ' OR 'KB' OR 'ZP' .
        wa_final-lv_AMOUNTOFTAXDEDUCTED = wa_wit-wt_qbshh.
      WHEN OTHERS.
        wa_final-lv_AMOUNTOFTAXDEDUCTED = wa_wit-wt_qbshh * 1.
    ENDCASE.

    CASE wa_bkpf-blart.
      WHEN 'KZ' OR 'KB' OR 'ZP' .
        wa_final-lv_TOTALTAXDEPOSITED = wa_wit-wt_qbshh.
      WHEN OTHERS.
        wa_final-lv_TOTALTAXDEPOSITED = wa_wit-wt_qbshh * 1.
    ENDCASE.
    wa_final-gjahr = wa_bkpf-gjahr.
    wa_final-bldat = wa_bkpf-bldat.
    wa_final-cpudt = wa_bkpf-cpudt.
    wa_final-budat = wa_bkpf-budat.
    wa_final-lv_DATEONWHICHTAXDEDUCTED = wa_bkpf-budat.



    READ TABLE it_t059z INTO wa_t059z WITH KEY wa_wit-witht.

    IF wa_wit-wt_amnman = 'X'.
      DATA(lv_rate) = ( wa_wit-wt_qbshh / wa_wit-wt_qsshh ) * 100.
    ELSE.
      lv_rate = wa_wit-qsatz.
    ENDIF.

    CASE wa_t059z-qscod.
      WHEN '94C'.
        wa_t059z-qscod = '194C'.
      WHEN '194I'.
        IF lv_rate = 2.
          wa_t059z-qscod = '194I(a)'.
        ELSEIF lv_rate = 10.
          wa_t059z-qscod = '194I(b)'.
        ELSE.
          wa_t059z-qscod = wa_t059z-qscod.
        ENDIF.
        wa_t059z-qscod = wa_t059z-qscod.
      WHEN OTHERS.
    ENDCASE.
    wa_final-lv_Scode = wa_t059z-qscod.

    READ TABLE it_T059D INTO wa_T059D WITH KEY wa_t059z-witht.
    CASE wa_t059d-rctxt.
      WHEN 'Company'.
        wa_t059d-rctxt = '01-Companies'.
      WHEN OTHERS.
        wa_t059d-rctxt = '02-Other than Companies'.
    ENDCASE.
    wa_final-rctxt = wa_t059d-rctxt.

    READ TABLE it_lfa1 INTO wa_lfa1  WITH KEY  lifnr = wa_wit-wt_acco.
    wa_final-j_1ipanno = wa_lfa1-j_1ipanno.


    READ TABLE it_but000 INTO wa_but000 WITH  KEY partner = wa_lfa1-lifnr.
    IF wa_but000-name_org1 IS NOT INITIAL.
      wa_final-lv_name = wa_but000-name_org1.
    ELSEIF wa_but000-name_org2 IS NOT INITIAL.
      wa_final-lv_name = wa_but000-name_org2.
    ELSEIF wa_but000-name_org3 IS NOT INITIAL.
      wa_final-lv_name = wa_but000-name_org3.
    ELSE.
      wa_final-lv_name = 'No name available'. " Fallback if all fields are empty
    ENDIF.

    READ TABLE it_adrc INTO wa_adrc WITH KEY addrnumber = wa_lfa1-adrnr.
    wa_final-str_suppl1 = wa_adrc-str_suppl1.
    wa_final-str_suppl2 = wa_adrc-str_suppl2.
    wa_final-street = wa_adrc-street.
    wa_final-post_code1 = wa_adrc-post_code1.

    READ TABLE it_t005u INTO wa_t005u WITH KEY bland = wa_lfa1-regio.
    wa_final-bland = wa_t005u-bland.

    READ TABLE it_adr6 INTO wa_adr6 WITH KEY addrnumber = wa_lfa1-adrnr.
    wa_final-vendoremail = wa_adr6-smtp_srch.
    "APPEND to final table
    APPEND wa_final TO it_final.
  ENDLOOP.



  " Initialize field catalog for ty_final structure

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '1'.
  ls_fcat-fieldname = 'BUKRS'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Company Code'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '2'.
  ls_fcat-fieldname = 'LV_PLANT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Plant'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '3'.
  ls_fcat-fieldname = 'NAME1'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Plant Name'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '4'.
  ls_fcat-fieldname = 'BELNR'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Document Number'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '5'.
  ls_fcat-fieldname = 'GJAHR'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Fiscal Year'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '6'.
  ls_fcat-fieldname = 'BLDAT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Document Date'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '7'.
  ls_fcat-fieldname = 'CPUDT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Entry Date'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '8'.
  ls_fcat-fieldname = 'LV_CHALANNO'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Challan Number'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '9'.
  ls_fcat-fieldname = 'LV_SCODE'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Section Code'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '10'.
  ls_fcat-fieldname = 'RCTXT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Reason Text'.
  APPEND ls_fcat TO lt_fcat.

  " Similarly, continue for the rest of the fields in ty_final structure

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '11'.
  ls_fcat-fieldname = 'J_1IPANNO'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'PAN Number'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '12'.
  ls_fcat-fieldname = 'LV_DRFFNO'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Draft Reference Number'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '13'.
  ls_fcat-fieldname = 'LV_NAME'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Vendor Name'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '14'.
  ls_fcat-fieldname = 'STR_SUPPL1'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Address Line 1'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '15'.
  ls_fcat-fieldname = 'STR_SUPPL2'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Address Line 2'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '16'.
  ls_fcat-fieldname = 'STREET'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Street'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '17'.
  ls_fcat-fieldname = 'LV_DEDUCTEEADDRESS5'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Deductee Address'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '18'.
  ls_fcat-fieldname = 'BLAND'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Region'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '19'.
  ls_fcat-fieldname = 'POST_CODE1'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Postal Code'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '20'.
  ls_fcat-fieldname = 'LV_AMOUNTOFPAYMENT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Amount of Payment'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '21'.
  ls_fcat-fieldname = 'BUDAT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Posting Date'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '22'.
  ls_fcat-fieldname = 'LV_RATEATWHICHTAXDEDUCTED'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Tax Deduction Rate'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '23'.
  ls_fcat-fieldname = 'LV_SURCHARGERATE'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Surcharge Rate'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '24'.
  ls_fcat-fieldname = 'LV_HEALTHANDEDUCATIONCESSRATE'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Education Cess Rate'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '25'.
  ls_fcat-fieldname = 'LV_AMOUNTOFTAXDEDUCTED'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Amount of Tax Deducted'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '26'.
  ls_fcat-fieldname = 'LV_SURCHARGEAMOUNT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Surcharge Amount'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '27'.
  ls_fcat-fieldname = 'LV_HEALTHANDEDUCATIONCESSAMT'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Education Cess Amount'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '28'.
  ls_fcat-fieldname = 'LV_TOTALTAXDEPOSITED'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Total Tax Deposited'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '29'.
  ls_fcat-fieldname = 'LV_DATEONWHICHTAXDEDUCTED'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Tax Deduction Date'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '30'.
  ls_fcat-fieldname = 'REASON'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Reason Code'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '31'.
  ls_fcat-fieldname = 'CERTIFICATENUMBER'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Certificate Number'.
  APPEND ls_fcat TO lt_fcat.

  CLEAR ls_fcat.
  ls_fcat-col_pos   = '32'.
  ls_fcat-fieldname = 'VENDOREMAIL'.
  ls_fcat-tabname   = 'z_final_data'.
  ls_fcat-seltext_m = 'Vendor Email'.
  APPEND ls_fcat TO lt_fcat.


* Call ALV grid display
  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      it_fieldcat   = lt_fcat
    TABLES
      t_outtab      = it_final
    EXCEPTIONS
      program_error = 1
      OTHERS        = 2.

  IF sy-subrc <> 0.
    MESSAGE 'Error in ALV display' TYPE 'E'.
  ENDIF.
