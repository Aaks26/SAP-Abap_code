*&---------------------------------------------------------------------*
*& Report ZMM_PURCHASE_GSTR_100
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zmm_purchase_gstr_100.

TABLES:rbkp,rseg,bseg ,mara,ekko.

INCLUDE zrmm_purchase_register_sss.
*INCLUDE zrmm_purchase_register_ss_cp.  " SELECTION SCREEN

INCLUDE zrmm_purchase_register_topp.
*INCLUDE zrmm_purchase_register_top_cp. "TABLE DECLARATION

START-OF-SELECTION.
  PERFORM get_tax_data.

  DATA:lv_saknr TYPE saknr.
  REFRESH gt_final.

  SELECT matnr matkl spart extwg
  FROM mara
  INTO TABLE lt_mara.


  IF sy-subrc = 0.
    SORT lt_mara BY matnr.
    DELETE ADJACENT DUPLICATES FROM lt_mara COMPARING matnr.

    LOOP AT lt_mara INTO ls_mara.
      lr_matnr-sign = 'I'.
      lr_matnr-option = 'EQ'.
      lr_matnr-low = ls_mara-matnr.

      APPEND lr_matnr.
      CLEAR lr_matnr.
    ENDLOOP.


  ENDIF.

  REFRESH lt_rbkp[].
  SELECT belnr  gjahr blart bldat budat
  usnam  xblnr bukrs lifnr waers
  wmwst1 landl gsber cpudt
  FROM rbkp
  INTO TABLE lt_rbkp
  WHERE budat IN s_postdt
  AND bukrs IN s_bukrs
  AND lifnr IN s_vendor.
  IF lt_rbkp[] IS NOT INITIAL.
    SORT lt_rbkp BY belnr gjahr.
******************************* DOC. Dec TABLE*****************Aakash j patel***********
    SELECT blart ltext
      FROM t003t
      INTO TABLE it_t003t
      FOR ALL ENTRIES IN lt_rbkp
      WHERE blart = lt_rbkp-blart AND spras = 'EN'.
**************vendor name***************
    SELECT lifnr name1 ort01 land1 regio j_1iexcd j_1iexrn j_1iexrg j_1iexdi j_1iexco j_1icstno j_1ilstno
    j_1ipanno j_1iexcive  j_1issist j_1ivtyp j_1ivencre j_1isern stceg ven_class
    FROM lfa1
    INTO TABLE lt_lfa1
    FOR ALL ENTRIES IN lt_rbkp
    WHERE lifnr = lt_rbkp-lifnr.
*****************Vendor GSTIN*****************
    SELECT partner taxtype taxnum taxnumxl
    FROM dfkkbptaxnum
    INTO TABLE lt_ven_gstin
    FOR ALL ENTRIES IN lt_rbkp
    WHERE partner = lt_rbkp-lifnr
    AND taxtype = 'IN3'.
*****************************************************************************
    REFRESH lt_rseg[].
    SELECT belnr gjahr buzei ebeln
    ebelp matnr bukrs werks
    wrbtr shkzg mwskz menge
    meins lfbnr lfgja lfpos
    lifnr hsn_sac xblnr
    FROM rseg
    INTO TABLE lt_rseg
    FOR ALL ENTRIES IN lt_rbkp
    WHERE belnr = lt_rbkp-belnr
    AND gjahr = lt_rbkp-gjahr
      AND ebeln IN s_ebeln.

    IF sy-subrc = 0 AND lt_mara IS INITIAL.
      SELECT matnr matkl spart extwg
      FROM mara
      INTO TABLE lt_mara
      FOR ALL ENTRIES IN lt_rseg
      WHERE matnr = lt_rseg-matnr.
    ENDIF.
***************************************************************************************
    IF lt_rseg[] IS NOT INITIAL.
      SELECT belnr,gjahr,buzei,saknr,anln1,bukrs
           FROM rbco
           INTO TABLE @DATA(lt_rbco)
           FOR ALL ENTRIES IN @lt_rseg
           WHERE belnr = @lt_rseg-belnr
             AND bukrs = @lt_rseg-bukrs
             AND gjahr = @lt_rseg-gjahr
             AND buzei = @lt_rseg-buzei.
      IF lt_rbco[] IS NOT INITIAL.

*            AND saknr = @lt_rbco-saknr.

        SELECT *
          FROM anlh
          INTO TABLE @DATA(lt_anlh)
          FOR ALL ENTRIES IN @lt_rbco
          WHERE bukrs IN @s_bukrs
            AND anln1 = @lt_rbco-anln1.
      ENDIF.

      SELECT *
      FROM skat
      INTO TABLE @DATA(lt_sakt)
*          FOR ALL ENTRIES IN @lt_rbco
            WHERE spras = @sy-langu
            AND ktopl = 'LGIN'.
    ENDIF.

  ENDIF.

  IF lt_lfa1[] IS NOT INITIAL.
    SORT lt_lfa1 BY lifnr.
  ENDIF.

  SELECT spras land1 bland bezei
  FROM t005u
  INTO TABLE lt_t005u
  WHERE spras = sy-langu
  AND land1 = 'IN'.

  IF lt_rseg[] IS NOT INITIAL.
    SORT lt_rseg BY bukrs belnr gjahr buzei.

    SELECT werks name1 j_1bbranch regio
    FROM t001w
    INTO TABLE lt_t001w
    FOR ALL ENTRIES IN lt_rseg
    WHERE werks = lt_rseg-werks.

    IF lt_t001w[] IS NOT INITIAL.
      SORT lt_t001w BY werks.

      SELECT bukrs branch gstin
      FROM j_1bbranch
      INTO TABLE lt_gstin
      FOR ALL ENTRIES IN lt_t001w
      WHERE branch = lt_t001w-j_1bbranch.
      IF lt_gstin[] IS NOT INITIAL.
        SORT lt_gstin BY bukrs branch.
      ENDIF.
    ENDIF.


    IF lt_mara[] IS NOT INITIAL.
      SORT lt_mara BY matnr.

      SELECT matnr spras maktx maktg
      FROM makt
      INTO TABLE lt_makt
      FOR ALL ENTRIES IN lt_mara
      WHERE matnr = lt_mara-matnr
      AND spras = sy-langu.
      IF lt_makt[] IS NOT INITIAL.
        SORT lt_makt[] BY matnr spras.
      ENDIF.
    ENDIF.

    SELECT matnr werks prctr steuc
    FROM marc
    INTO TABLE lt_marc
    FOR ALL ENTRIES IN lt_rseg
    WHERE matnr = lt_rseg-matnr
    AND werks = lt_rseg-werks.
    IF  lt_marc IS NOT INITIAL.
      SORT lt_marc BY matnr werks.
    ENDIF.

    SELECT spras kalsm mwskz text1
    FROM t007s
    INTO TABLE lt_t007s
    FOR ALL ENTRIES IN lt_rseg
    WHERE spras = sy-langu
    AND kalsm = 'TAXINN'
    AND mwskz = lt_rseg-mwskz.

    IF lt_t007s[] IS NOT INITIAL.
      SORT lt_t007s BY spras kalsm mwskz.
    ENDIF.

    SELECT ebeln bsart bedat ekorg knumv bstyp ekgrp
    FROM ekko
    INTO TABLE lt_ekko
    FOR ALL ENTRIES IN lt_rseg
    WHERE ebeln = lt_rseg-ebeln.
    IF lt_ekko[] IS NOT INITIAL.
      SORT lt_ekko[] BY ebeln.

      SELECT knumv kposn stunr zaehk kschl lifnr kwert
      FROM prcd_elements
      INTO TABLE lt_prcd
      FOR ALL ENTRIES IN lt_ekko
      WHERE knumv = lt_ekko-knumv
      AND kschl IN ('JSDB' , 'JEDB' , 'JCDB').

      IF lt_prcd[] IS NOT INITIAL.
        SORT lt_prcd[] BY knumv kposn.
      ENDIF.

      SELECT ebeln
      ebelp
      loekz
      txz01
      matnr
      werks
      lgort
      matkl
      netpr
      pstyp ps_psp_pnr meins
      FROM ekpo  INTO TABLE lt_ekpo
      FOR ALL ENTRIES IN lt_ekko
      WHERE ebeln = lt_ekko-ebeln.
    ENDIF.
************************************ Aj  used EKKN for WBS and asset
    SELECT ebeln ebelp prctr ps_psp_pnr anln1
    FROM ekkn
    INTO TABLE lt_ekkn
    FOR ALL ENTRIES IN lt_rseg
    WHERE ebeln = lt_rseg-ebeln
    AND ebelp = lt_rseg-ebelp.

    IF lt_ekkn[] IS NOT INITIAL.
      SORT lt_ekkn BY ebeln ebelp.
    ENDIF.
*---------------------------  AJ WBS  dec. select query
    SELECT pspnr poski post1 posid
      INTO TABLE it_prps
      FROM prps
      FOR ALL ENTRIES IN lt_ekkn
      where pspnr = lt_ekkn-ps_psp_pnr.
****************For EKBE table Data********************
    REFRESH lt_ekbe[].
    SELECT ebeln ebelp zekkn
           vgabe gjahr belnr
           buzei bewtp bwart
           budat menge dmbtr
           wrbtr bpmng shkzg mwskz xblnr
    FROM ekbe
    INTO TABLE lt_ekbe
    FOR ALL ENTRIES IN lt_rseg
    WHERE ebeln = lt_rseg-ebeln
    AND ebelp = lt_rseg-ebelp.

    IF lt_ekbe[] IS NOT INITIAL.
      SORT lt_ekbe BY belnr gjahr.
      lt_ekbe_inv[] = lt_ekbe[].
      lt_ekbe_grn[] = lt_ekbe[].
      DELETE lt_ekbe_inv WHERE bewtp <> 'Q'.     " for INvoice Documents
      DELETE lt_ekbe_grn WHERE bewtp <> 'E'.     " for GRN Documents

      IF lt_ekbe_grn IS NOT INITIAL.
        SORT lt_ekbe_grn BY belnr DESCENDING.
      ENDIF.
************************************************ AJ ********************* Aakash j patel
      REFRESH gt_nsdm_mkpf[].
      SELECT mblnr mjahr lfbnr lfbja budat_mkpf ebeln ebelp nplnr aufpl aplzl projn ps_psp_pnr
        FROM nsdm_v_mseg
        INTO TABLE gt_nsdm_mkpf
        FOR ALL ENTRIES IN lt_rseg
        WHERE ebeln = lt_rseg-ebeln
          AND ebelp = lt_rseg-ebelp.

      SELECT aufnr ktext
        FROM m_aukob
        INTO TABLE it_aukob
        FOR ALL ENTRIES IN gt_nsdm_mkpf
        WHERE aufnr = gt_nsdm_mkpf-nplnr .
    ENDIF.

    SELECT aufpl aplzl vornr ltxa1 projn
      FROM afvc
      INTO TABLE it_afvc
      FOR ALL ENTRIES IN gt_nsdm_mkpf
      WHERE aufpl = gt_nsdm_mkpf-aufpl AND aplzl = gt_nsdm_mkpf-aplzl.
*************************** Asset dec. and Acc. Group *************************************
    SELECT bukrs anln1 ktogr txt50
      INTO TABLE it_anla
      FROM anla
      FOR ALL ENTRIES IN lt_ekkn
      WHERE anln1 = lt_ekkn-anln1.
************************************* Acc. Group dec.
    SELECT ktogr  ktgrtx
      INTO TABLE it_t095t
      FROM t095t
      FOR ALL ENTRIES IN it_anla
      WHERE ktogr  = it_anla-ktogr.
*************************************************************************************
***    start of change by sunil
    TYPES:BEGIN OF ty_rseg_temp,
            awkey TYPE awkey,
            ebeln TYPE ebeln,
            ebelp TYPE ebelp,
            matnr TYPE matnr,
            menge TYPE menge_d,
          END OF ty_rseg_temp.

    DATA:lt_rseg_temp TYPE STANDARD TABLE OF ty_rseg_temp,

         lv_awkey     TYPE awkey,
         lv_line      TYPE i.

    FIELD-SYMBOLS:<fs_rseg_temp> TYPE ty_rseg_temp,
                  <fs_rseg>      LIKE LINE OF lt_rseg.

    LOOP AT lt_rseg ASSIGNING <fs_rseg>.
      APPEND INITIAL LINE TO lt_rseg_temp ASSIGNING <fs_rseg_temp>.
      CONCATENATE <fs_rseg>-belnr <fs_rseg>-gjahr INTO <fs_rseg_temp>-awkey.
      <fs_rseg_temp>-ebeln = <fs_rseg>-ebeln.
      <fs_rseg_temp>-ebelp = <fs_rseg>-ebelp.
      <fs_rseg_temp>-matnr = <fs_rseg>-matnr.
      <fs_rseg_temp>-menge = <fs_rseg>-menge.
    ENDLOOP.

    IF lt_rseg_temp IS NOT INITIAL.
      SORT lt_rseg_temp BY awkey ebeln ebelp matnr menge.

      SELECT  belnr
      buzei
      gjahr
      awkey
      ebeln
      ebelp
      mwskz
      wrbtr
      ktosl
      matnr
      bupla"added by sunil dt:10.10.2018
      FROM bseg APPENDING TABLE lt_bseg
      FOR ALL ENTRIES IN lt_rseg_temp
      WHERE awkey = lt_rseg_temp-awkey AND
      ebeln = lt_rseg_temp-ebeln AND
      ebelp = lt_rseg_temp-ebelp AND
      matnr = lt_rseg_temp-matnr .
      IF sy-subrc = 0.
        SELECT bukrs
        belnr
        gjahr
        bldat
        budat
        usnam
        xblnr
        waers
        bktxt xblnr_alt
        FROM bkpf
        INTO TABLE lt_bkpf
        FOR ALL ENTRIES IN lt_bseg
        WHERE bukrs IN s_bukrs AND
        belnr = lt_bseg-belnr AND
        gjahr = lt_bseg-gjahr.

      ENDIF.
    ENDIF.
**    end of change by sunil
    IF lt_bseg[] IS NOT INITIAL.
      SORT lt_bseg BY belnr gjahr buzei.

      SELECT bukrs
      belnr
      gjahr
      buzei
      buzid
      koart
      awkey
      dmbtr
      hkont
      lifnr
      wrbtr
      ktosl
      txgrp
      ebeln
      ebelp
      shkzg
      mwskz
      taxps
      prctr
      gsber
      matnr
      menge
      xref3
      bupla
      FROM bseg INTO TABLE lt_bseg_1
      FOR ALL ENTRIES IN lt_bseg
      WHERE awkey = lt_bseg-awkey.

      IF lt_bseg_1[] IS NOT INITIAL.
        REFRESH it_with[].
        SELECT bukrs belnr gjahr buzei witht wt_qbshh
          FROM with_item
          INTO TABLE it_with
          FOR ALL ENTRIES IN lt_bseg_1
          WHERE bukrs = lt_bseg_1-bukrs
            AND belnr = lt_bseg_1-belnr
            AND gjahr = lt_bseg_1-gjahr
            AND buzei = lt_bseg_1-buzei.

        DELETE it_with WHERE wt_qbshh IS INITIAL.

        LOOP AT lt_bseg_1 INTO ls_bseg_1.
          MOVE-CORRESPONDING ls_bseg_1 TO ls_bseg_2.
          ls_bseg_2-belnr_n = ls_bseg_1-awkey+0(10).
          APPEND ls_bseg_2 TO lt_bseg_2.
          CLEAR ls_bseg_2.
        ENDLOOP.

        SELECT bukrs belnr
        gjahr
        buzei
        hwbas
        hwste
        kschl
        txgrp
        shkzg
        mwskz
        taxps
        kbetr
        FROM bset
        INTO TABLE lt_bset
        FOR ALL ENTRIES IN lt_bseg_1
        WHERE belnr = lt_bseg_1-belnr
          AND bukrs = lt_bseg_1-bukrs
        AND gjahr = lt_bseg_1-gjahr AND
        txgrp = lt_bseg_1-txgrp.

        IF lt_bset[] IS NOT INITIAL.
          SORT lt_bset BY bukrs belnr gjahr hwbas.
        ENDIF.
      ENDIF.
    ENDIF.
  ENDIF.

  LOOP AT lt_rseg ASSIGNING <ls_rseg>.
    ls_rseg_sum-belnr = <ls_rseg>-belnr.
    ls_rseg_sum-gjahr = <ls_rseg>-gjahr.
    ls_rseg_sum-wrbtr = <ls_rseg>-wrbtr.
    COLLECT ls_rseg_sum INTO lt_rseg_sum.
  ENDLOOP.

  SORT   lt_bseg_1 BY awkey gjahr ebeln ebelp.

  LOOP AT lt_bseg_1 ASSIGNING <fs_bseg_1>.
    ls_bseg_summ-awkey = <fs_bseg_1>-awkey.
    ls_bseg_summ-gjahr = <fs_bseg_1>-gjahr.
    ls_bseg_summ-ebeln = <fs_bseg_1>-ebeln.
    ls_bseg_summ-ebelp = <fs_bseg_1>-ebelp.
    IF <fs_bseg_1>-shkzg = 'H'.
      ls_bseg_summ-dmbtr = <fs_bseg_1>-dmbtr * -1.
    ELSE.
      ls_bseg_summ-dmbtr = <fs_bseg_1>-dmbtr.
    ENDIF.
    COLLECT ls_bseg_summ INTO lt_bseg_summ.
  ENDLOOP.

  SORT lt_lfa1 BY lifnr.
  SORT lt_bset BY belnr gjahr txgrp.



*******************************************************************
  LOOP AT lt_rseg ASSIGNING <ls_rseg>.
    CLEAR ls_ekpo.
    READ TABLE lt_ekpo INTO ls_ekpo WITH KEY ebeln = <ls_rseg>-ebeln
                                             ebelp = <ls_rseg>-ebelp.
*    IF sy-subrc = 0.
*      gs_final-mat_desc = ls_ekpo-txz01.
*    ENDIF.
    gs_final-hsn_code = <ls_rseg>-hsn_sac.
    gs_final-buzei = <ls_rseg>-buzei.
    CLEAR ls_rbkp.
    READ TABLE lt_rbkp INTO ls_rbkp WITH KEY
    belnr = <ls_rseg>-belnr
    gjahr = <ls_rseg>-gjahr.
    IF sy-subrc = 0.
      gs_final-bukrs = ls_rbkp-bukrs.
      gs_final-vendor = ls_rbkp-lifnr.
      gs_final-vend_inv = ls_rbkp-xblnr.
      gs_final-vend_inv_dt = ls_rbkp-bldat.
*      gs_final-busi_area = ls_rbkp-gsber.
      gs_final-budat = ls_rbkp-budat.
      gs_final-bldat = ls_rbkp-bldat.
      gs_final-waers = ls_rbkp-waers.
      gs_final-usnam = ls_rbkp-usnam.
      gs_final-blart = ls_rbkp-blart.
      gs_final-land1 = ls_rbkp-landl.
      gs_final-cpudt = ls_rbkp-cpudt.
************************************ DOC type dec. *********** Aakash j patel**********
      READ TABLE it_t003t INTO wa_t003t WITH KEY blart = ls_rbkp-blart.
      gs_final-ltext = wa_t003t-ltext.
*******************************************************************************
      CLEAR ls_lfa1.
      READ TABLE lt_lfa1 INTO ls_lfa1 WITH KEY lifnr = ls_rbkp-lifnr BINARY SEARCH.
      IF sy-subrc = 0.
        gs_final-v_name1 = ls_lfa1-name1.
        gs_final-vat_no = ls_lfa1-stceg.       " Tin No
        gs_final-j_1icstno = ls_lfa1-j_1icstno.
        gs_final-j_1isern = ls_lfa1-j_1isern.
        gs_final-j_1ipanno = ls_lfa1-j_1ipanno.
        gs_final-j_1ilstno = ls_lfa1-j_1ilstno.
        gs_final-j_1iexcd = ls_lfa1-j_1iexcd.
        gs_final-regio = ls_lfa1-regio.
        gs_final-ven_class = ls_lfa1-ven_class.

        IF gs_final-ven_class IS INITIAL.
          gs_final-ven_class_desc = 'Registered'.
        ELSEIF gs_final-ven_class = '0'.
          gs_final-ven_class_desc = 'Not Registered'.
        ELSEIF gs_final-ven_class = '1'.
          gs_final-ven_class_desc = 'Compounding Scheme'.
        ENDIF.

        READ TABLE lt_t005u INTO ls_t005u WITH KEY  spras = sy-langu
        bland = ls_lfa1-regio.
        IF sy-subrc = 0.
          gs_final-bezei = ls_t005u-bezei.
        ENDIF.
      ENDIF.

***************vendor gstin************************************
      READ TABLE lt_ven_gstin INTO ls_ven_gstin WITH KEY partner = ls_rbkp-lifnr
      taxtype = 'IN3'.
      IF sy-subrc = 0.
        gs_final-ven_gstin = ls_ven_gstin-taxnum.
      ENDIF.
    ENDIF.

*************** Material Data *********************************
    CLEAR ls_mara.
    gs_final-matnr = <ls_rseg>-matnr.
    READ TABLE lt_mara INTO ls_mara WITH KEY matnr = <ls_rseg>-matnr BINARY SEARCH.
    IF sy-subrc = 0.
      gs_final-mat_grp = ls_mara-matkl.
      READ TABLE lt_makt INTO ls_makt WITH KEY matnr = ls_mara-matnr
      spras = sy-langu BINARY SEARCH.
      IF sy-subrc = 0.
        gs_final-mat_desc = ls_makt-maktx.
      ENDIF.
    ENDIF.

    gs_final-belnr = <ls_rseg>-belnr.

    READ TABLE lt_rbco INTO DATA(ls_rbco) WITH KEY belnr = <ls_rseg>-belnr
                                                   gjahr = <ls_rseg>-gjahr
                                                   buzei = <ls_rseg>-buzei
                                                   bukrs = <ls_rseg>-bukrs.
    IF sy-subrc = 0.
      gs_final-saknr = ls_rbco-saknr.
      gs_final-anln1 = ls_rbco-anln1.

      READ TABLE lt_sakt INTO DATA(ls_sakt) WITH KEY saknr = gs_final-saknr.
      IF sy-subrc = 0.
        gs_final-gl_desc = ls_sakt-txt50.
        CLEAR ls_sakt.
      ENDIF.
      READ TABLE lt_anlh INTO DATA(ls_anlh) WITH KEY anln1 = ls_rbco-anln1.
      IF sy-subrc = 0.
        gs_final-ass_desc = ls_anlh-anlhtxt.
      ENDIF.
    ENDIF.

    IF gs_final-saknr IS INITIAL.

      DATA:lv_mat TYPE matnr.
      CLEAR lv_mat.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
        EXPORTING
          input  = gs_final-matnr
        IMPORTING
          output = lv_mat.

      CLEAR lv_saknr.
      CONCATENATE '252' lv_mat+0(3) INTO lv_saknr.
      gs_final-saknr = lv_saknr.
      CALL FUNCTION 'CONVERSION_EXIT_ALPHA_INPUT'
        EXPORTING
          input  = gs_final-saknr
        IMPORTING
          output = gs_final-saknr.

      READ TABLE lt_sakt INTO DATA(ls_sakt1) WITH KEY saknr = gs_final-saknr.
      IF sy-subrc = 0.
        gs_final-gl_desc = ls_sakt1-txt50.
        CLEAR:ls_sakt1.
      ENDIF.
    ENDIF.

*    gs_final-xblnr = <ls_rseg>-xblnr.
    IF <ls_rseg>-shkzg = 'H'.
      gs_final-menge = <ls_rseg>-menge * ( -1 ).
    ELSE.
      gs_final-menge = <ls_rseg>-menge.
    ENDIF.
    gs_final-meins = <ls_rseg>-meins.
******************************************* UOM
    IF <ls_rseg>-meins IS INITIAL.
      gs_final-meins = <ls_rseg>-bstme.
    ENDIF.

    IF <ls_rseg>-shkzg = 'H'.
      gs_final-wrbtr = <ls_rseg>-wrbtr * -1.
    ELSEIF <ls_rseg>-shkzg = 'S'.
      gs_final-wrbtr = <ls_rseg>-wrbtr.
    ENDIF.

    gs_final-tax_code = <ls_rseg>-mwskz.
    gs_final-ebeln = <ls_rseg>-ebeln.
    gs_final-werks = <ls_rseg>-werks.
    gs_final-shkzg = <ls_rseg>-shkzg.     " Debit/ Credit
    gs_final-mblnr = <ls_rseg>-lfbnr.
    gs_final-mjahr = <ls_rseg>-lfgja.

*****************For GRN Documents************************************
    CLEAR ls_ekbe_grn.
    READ TABLE lt_ekbe_grn INTO ls_ekbe_grn WITH KEY belnr = <ls_rseg>-lfbnr
                                                     gjahr = <ls_rseg>-lfgja.
    IF sy-subrc = 0.
      gs_final-grn_date = ls_ekbe_grn-budat.
      gs_final-ref = ls_ekbe_grn-xblnr.
    ELSE.
      CLEAR gs_nsdm_mkpf.
**************************************** AJ ******************************** " Aakash j patel   " Network
      READ TABLE gt_nsdm_mkpf INTO gs_nsdm_mkpf WITH KEY lfbnr = <ls_rseg>-lfbnr
                                                         lfbja = <ls_rseg>-lfgja.
      IF sy-subrc = 0.
        gs_final-grn_date = gs_nsdm_mkpf-budat_mkpf.
        gs_final-nplnr = gs_nsdm_mkpf-nplnr.   " network
      ENDIF.
    ENDIF.

    READ TABLE it_aukob INTO wa_aukob WITH KEY aufnr = gs_nsdm_mkpf-nplnr.  " network name
    gs_final-ktext = wa_aukob-ktext.  "

    READ TABLE it_afvc INTO wa_afvc WITH  KEY  aufpl = gs_nsdm_mkpf-aufpl  aplzl = gs_nsdm_mkpf-aplzl.
    gs_final-vornr = wa_afvc-vornr.   " activity
    gs_final-ltxa1 = wa_afvc-ltxa1.     " activity name


    READ TABLE lt_ekkn INTO ls_ekkn WITH  KEY ebeln = <ls_rseg>-ebeln ebelp = <ls_rseg>-ebelp.
    IF sy-subrc = 0.
      gs_final-ps_psp_pnr = ls_ekkn-ps_psp_pnr.  " WBS
      gs_final-anln1 = ls_ekkn-anln1.             " Asset
    ENDIF.

    READ TABLE it_anla INTO wa_anla WITH  KEY anln1 = ls_ekkn-anln1.
    IF sy-subrc = 0.
      gs_final-txt50 = wa_anla-txt50.     " asset dec.
      gs_final-ktogr = wa_anla-ktogr.       " acc. group
    ENDIF.
    READ TABLE it_t095t INTO wa_t095t WITH  KEY ktogr = wa_anla-ktogr.
    IF sy-subrc = 0.
      gs_final-ktgrtx = wa_t095t-ktgrtx.        " Acc. grp  Dec.
    ENDIF.

    READ TABLE it_prps INTO wa_prps WITH KEY pspnr = wa_afvc-projn.
    IF sy-subrc = 0.
      gs_final-poski = wa_prps-posid.
      gs_final-posid = wa_prps-posid.
    ENDIF.

    READ TABLE it_prps INTO wa_prps WITH KEY pspnr = ls_ekkn-ps_psp_pnr.
    IF sy-subrc = 0 AND ls_ekkn-ps_psp_pnr IS NOT INITIAL.
      gs_final-post1 = wa_prps-post1.  " wbs dec.
    ENDIF.


************************************************************************************************
**************For Business Place & GST IN number**********************
    READ TABLE lt_t001w INTO ls_t001w WITH KEY werks = <ls_rseg>-werks.
    IF sy-subrc = 0.
      gs_final-plant_name = ls_t001w-name1.
*      gs_final-j_1bbranch = ls_t001w-j_1bbranch." Commented by sunil dt:10.10.2018
      gs_final-plant_regio = ls_t001w-regio.

      READ TABLE lt_gstin INTO ls_gstin WITH KEY branch = ls_t001w-j_1bbranch.
      IF sy-subrc = 0.
        gs_final-plant_gstin = ls_gstin-gstin.
        gs_final-gstin = ls_gstin-gstin.
      ENDIF.

      READ TABLE lt_t005u INTO ls_t005u WITH KEY  spras = sy-langu
      bland = ls_t001w-regio.
      IF sy-subrc = 0.
        gs_final-plant_regio_desc = ls_t005u-bezei.
      ENDIF.
    ENDIF.


****************For Rate of Invoice *******************
    gs_final-rate = <ls_rseg>-wrbtr / <ls_rseg>-menge.

****************Tax Code Description*******************
    CLEAR ls_t007s.
    READ TABLE lt_t007s INTO ls_t007s WITH KEY spras = sy-langu
    kalsm = 'TAXINN'
    mwskz = <ls_rseg>-mwskz.
    IF sy-subrc = 0.
      gs_final-tax_desc = ls_t007s-text1.
    ENDIF.
*********************For PO Date************************
    CLEAR ls_ekko.
    READ TABLE lt_ekko INTO ls_ekko WITH KEY ebeln = <ls_rseg>-ebeln BINARY SEARCH.
    IF sy-subrc = 0.
      gs_final-po_date = ls_ekko-bedat.
      gs_final-bsart   = ls_ekko-bsart.
      gs_final-ekorg   = ls_ekko-ekorg.
      gs_final-ekgrp   = ls_ekko-ekgrp.
      READ TABLE lt_ekpo INTO ls_ekpo WITH KEY ebeln = ls_ekko-ebeln
      ebelp = <ls_rseg>-ebelp. " added by pramod
      gs_final-meins = ls_ekpo-meins.    " Aakash J patel ---- Aj ----13-02-2025   of UOM.
      IF sy-subrc = 0 AND ls_ekpo-pstyp = '3'.
        gs_final-bstyp  = 'L'."ls_ekpo-pstyp.
      ENDIF.
      CLEAR ls_prcd.
      READ TABLE lt_prcd INTO ls_prcd WITH KEY knumv = ls_ekko-knumv
      kposn = <ls_rseg>-ebelp.
      IF sy-subrc = 0.
        IF ls_prcd-kschl = 'JCDB'.

          IF <ls_rseg>-shkzg = 'H'.
            gs_final-jcdb_amnt = ls_prcd-kwert * -1.
          ELSEIF <ls_rseg>-shkzg = 'S'.
            gs_final-jcdb_amnt = ls_prcd-kwert.
          ENDIF.

        ELSEIF ls_prcd-kschl = 'JEDB'.

          IF <ls_rseg>-shkzg = 'H'.
            gs_final-jedb_amnt = ls_prcd-kwert * -1.
          ELSEIF <ls_rseg>-shkzg = 'S'.
            gs_final-jedb_amnt = ls_prcd-kwert.
          ENDIF.

        ELSEIF ls_prcd-kschl = 'JSDB'.

          IF <ls_rseg>-shkzg = 'H'.
            gs_final-jsdb_amnt = ls_prcd-kwert * -1.
          ELSEIF <ls_rseg>-shkzg = 'S'.
            gs_final-jsdb_amnt = ls_prcd-kwert.
          ENDIF.

        ENDIF.
      ENDIF.
    ENDIF.
****************Profit Center****************************
    CLEAR ls_marc.
*************** Vendor Amount******************************
    CLEAR ls_bseg.

    ON CHANGE OF <ls_rseg>-belnr.
      READ TABLE lt_bseg INTO ls_bseg WITH KEY   belnr = <ls_rseg>-belnr
      buzei = <ls_rseg>-buzei
      gjahr = <ls_rseg>-gjahr BINARY SEARCH.
      IF sy-subrc = 0.
*      ON CHANGE OF <ls_rseg>-belnr.

        CLEAR ls_bseg_1.
        READ TABLE lt_bseg_1 INTO ls_bseg_1 WITH KEY awkey = ls_bseg-awkey
        gjahr = ls_bseg-gjahr
        koart = 'K'.
        IF sy-subrc = 0.
          IF <ls_rseg>-shkzg = 'S'.
            gs_final-vend_amt = ls_bseg_1-dmbtr.
          ELSEIF <ls_rseg>-shkzg = 'H'.
            gs_final-vend_amt = ( ls_bseg_1-dmbtr ) * -1.
          ENDIF.
        ENDIF.
        READ TABLE lt_rseg_sum INTO ls_rseg_sum WITH KEY belnr = <ls_rseg>-belnr
        gjahr = ls_rbkp-gjahr.
        IF sy-subrc = 0.
          gs_final-diff_amnt = gs_final-vend_amt - ( ls_rseg_sum-wrbtr + ls_rbkp-wmwst1 ).
        ENDIF.

        lv_belnr_temp = <ls_rseg>-belnr.

*      ENDON.
      ELSE. " added by sunil dt:13.03.2018
        CONCATENATE <ls_rseg>-belnr <ls_rseg>-gjahr INTO lv_awkey.
        READ TABLE lt_bseg INTO ls_bseg WITH KEY awkey = lv_awkey
        ebeln = <ls_rseg>-ebeln
        ebelp = <ls_rseg>-ebelp
        matnr = <ls_rseg>-matnr.
        IF sy-subrc = 0 .


          READ TABLE lt_rseg_sum INTO ls_rseg_sum
          WITH KEY belnr = <ls_rseg>-belnr
          gjahr = ls_rbkp-gjahr.
          IF sy-subrc = 0.
            gs_final-diff_amnt = gs_final-vend_amt - ( ls_rseg_sum-wrbtr + ls_rbkp-wmwst1 ).
          ENDIF.
*        ENDON.
        ENDIF.
      ENDIF.
    ENDON.
*************************FI Doc************************************
    CLEAR : ls_bseg_1, lv_txgrp, lv_belnr, lv_gjahr.
**    start of change by sunil

    DATA lv_matnr TYPE matnr.
    CLEAR lv_matnr.

    CALL FUNCTION 'CONVERSION_EXIT_ALPHA_OUTPUT'
      EXPORTING
        input  = <ls_rseg>-matnr
      IMPORTING
        output = lv_matnr.

****start of addition by sunil 05.07.2018
***    Ekbe case
*    READ TABLE lt_bseg INTO ls_bseg WITH KEY   belnr = <ls_rseg>-belnr
*                                               buzei = <ls_rseg>-buzei
*                                               gjahr = <ls_rseg>-gjahr BINARY SEARCH.
*    IF sy-subrc <> 0.
    CONCATENATE <ls_rseg>-belnr <ls_rseg>-gjahr INTO lv_awkey.
    READ TABLE lt_bseg INTO ls_bseg WITH KEY awkey = lv_awkey
    ebeln = <ls_rseg>-ebeln
    ebelp = <ls_rseg>-ebelp
    matnr = <ls_rseg>-matnr.

*    ENDIF.

***    end of addition by sunil
*--> Added By Bijalkumar Chauhan (24.08.2018)
    CLEAR gv_xref3.
    IF <ls_rseg>-lfbnr IS NOT INITIAL
    AND <ls_rseg>-lfgja IS NOT INITIAL
    AND <ls_rseg>-lfpos IS NOT INITIAL.

      gv_xref3 = <ls_rseg>-lfgja && <ls_rseg>-lfbnr && <ls_rseg>-lfpos.
    ENDIF.

    IF gv_xref3 IS NOT INITIAL.
      SORT lt_bseg_1[] BY buzid awkey ebeln xref3.
      READ TABLE lt_bseg_1 ASSIGNING <fs_bseg_1>
      WITH KEY "buzid = 'W'"commented by sunil dt:10.10.2018
      awkey = ls_bseg-awkey
      ebeln = <ls_rseg>-ebeln
      xref3 = gv_xref3
      BINARY SEARCH.
      IF sy-subrc = 0.
        <fs_bseg_1>-flag = 'X'.
        gs_final-ktosl   = <fs_bseg_1>-ktosl.

        IF ls_rbkp-waers EQ 'INR'.
          gs_final-dmbtr   = gs_final-wrbtr.
        ELSE.
          READ TABLE lt_bseg_summ INTO ls_bseg_summ WITH KEY awkey = ls_bseg-awkey
          gjahr = ls_bseg-gjahr
          ebeln = <ls_rseg>-ebeln
          ebelp = <ls_rseg>-ebelp.
          IF sy-subrc = 0.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-dmbtr   = ls_bseg_summ-dmbtr * -1 ."<fs_bseg_1>-dmbtr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-dmbtr   = ls_bseg_summ-dmbtr."<fs_bseg_1>-dmbtr.
            ENDIF.
          ENDIF.
        ENDIF.

        lv_txgrp = <fs_bseg_1>-txgrp.
        lv_belnr = <fs_bseg_1>-belnr.
        lv_gjahr = <fs_bseg_1>-gjahr.

        gs_final-fi_doc = <fs_bseg_1>-belnr.

        CLEAR is_with.
        READ TABLE it_with INTO is_with WITH KEY bukrs = <fs_bseg_1>-bukrs
                                                 belnr = <fs_bseg_1>-belnr
                                                 buzei = <fs_bseg_1>-buzei
                                                 gjahr = <fs_bseg_1>-gjahr.
        IF sy-subrc = 0.
          gs_final-wt_qbshh = is_with-wt_qbshh.    " Aj 13-02-2025
        ENDIF.

        CLEAR gs_final1.                            "RS:Added dt:04-12-2024.
        READ TABLE gt_final INTO gs_final1 WITH KEY fi_doc = <fs_bseg_1>-belnr.
        IF gs_final1-with_tax IS INITIAL.
          READ TABLE lt_bseg_1 INTO DATA(ls_bseg_t) WITH KEY bukrs = <fs_bseg_1>-bukrs
                                                             belnr = <fs_bseg_1>-belnr
                                                             gjahr = <fs_bseg_1>-gjahr
                                                             ktosl = 'WIT'.
          IF sy-subrc = 0.
            gs_final-with_tax = ls_bseg_t-wrbtr * -1.        "RS:end dt:04-12-2024.S
          ENDIF.
        ENDIF.
        CLEAR gs_final1.
        READ TABLE gt_final INTO gs_final1 WITH KEY fi_doc = <fs_bseg_1>-belnr.
        IF gs_final1-vend_amt IS INITIAL.
          CLEAR ls_bseg_1.
          READ TABLE lt_bseg_1 INTO ls_bseg_1 WITH KEY belnr = gs_final-fi_doc
                                                       awkey = ls_bseg-awkey
                                                       gjahr = ls_bseg-gjahr
                                                       koart = 'K'.
          IF sy-subrc = 0.
            IF <ls_rseg>-shkzg = 'S'.
              gs_final-vend_amt = ls_bseg_1-dmbtr.
            ELSEIF <ls_rseg>-shkzg = 'H'.
              gs_final-vend_amt = ( ls_bseg_1-dmbtr ) * -1.
            ENDIF.
          ENDIF.
        ENDIF.
        gs_final-prctr  = <fs_bseg_1>-prctr.
        gs_final-busi_area = <fs_bseg_1>-gsber.
        lv_tabix = sy-tabix.
      ELSE.
        PERFORM get_tax_data.   "Get tax line item data
      ENDIF.
    ELSE.
      PERFORM get_tax_data.   "Get tax line item data
    ENDIF.
*--> End of changes

** End of change by sunil.
    CLEAR : ls_bset, lv_awkey.
    CONCATENATE <ls_rseg>-belnr <ls_rseg>-gjahr INTO lv_awkey.
    READ TABLE lt_bseg_1 INTO ls_bseg_1   WITH KEY  awkey = lv_awkey
    bukrs = <ls_rseg>-bukrs
    ebeln = <ls_rseg>-ebeln
    ebelp = <ls_rseg>-ebelp
    menge = <ls_rseg>-menge
    matnr = <ls_rseg>-matnr
    txgrp = lv_txgrp.
    IF sy-subrc = 0.
      READ TABLE lt_bset INTO ls_bset WITH KEY bukrs = ls_bseg_1-bukrs
                                               belnr = ls_bseg_1-belnr
                                               gjahr = ls_bseg_1-gjahr
                                               txgrp = ls_bseg_1-txgrp.
      IF sy-subrc = 0.
        LOOP AT lt_bset INTO ls_bset FROM sy-tabix.
          IF ls_bset-bukrs <> ls_bseg_1-bukrs OR ls_bset-belnr <> ls_bseg_1-belnr OR
          ls_bset-gjahr <> ls_bseg_1-gjahr OR
          ls_bset-txgrp <> ls_bseg_1-txgrp.
            EXIT.
          ENDIF.

          IF ls_bset-kschl = 'JMOP'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-excise_amnt = ls_bset-hwste * -1.       "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-excise_amnt = ls_bset-hwste.       "Deductable
            ENDIF.

          ELSEIF ls_bset-kschl = 'JMIP'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-excise_amnt_nd = ls_bset-hwste * -1.    " Non Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-excise_amnt_nd = ls_bset-hwste.    " Non Deductable
            ENDIF.


          ELSEIF ls_bset-kschl = 'JVRD'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-vat_amnt  = ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-vat_amnt  = ls_bset-hwste.        "Deductable
            ENDIF.


          ELSEIF ls_bset-kschl = 'JVRN'.                " Non Deductable
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-vat_amnt_nd  =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-vat_amnt_nd  =  ls_bset-hwste.
            ENDIF.

          ELSEIF ls_bset-kschl = 'JVCS'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-cst_amnt  =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-cst_amnt  =  ls_bset-hwste.
            ENDIF.

          ELSEIF ls_bset-kschl = 'JIMD'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-import_amnt   =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-import_amnt   =  ls_bset-hwste.
            ENDIF.


          ELSEIF ls_bset-kschl = 'JIMN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-import_non_ded   =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-import_non_ded   =  ls_bset-hwste.
            ENDIF.

********************For GST Taxes*******************************

********deductable
          ELSEIF ls_bset-kschl = 'JIIG'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jiig_amnt = ls_bset-hwste * -1.
              gs_final-jiig_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jiig_amnt = ls_bset-hwste.
              gs_final-jiig_per = ls_bset-kbetr.
            ENDIF.

*          gs_final-ded_per_f = gs_final-jiig_per.

          ELSEIF ls_bset-kschl = 'JISG'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jisg_amnt = ls_bset-hwste * -1.
              gs_final-jisg_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jisg_amnt = ls_bset-hwste.
              gs_final-jisg_per = ls_bset-kbetr.
            ENDIF.



          ELSEIF ls_bset-kschl = 'JICG'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jicg_amnt = ls_bset-hwste * -1.
              gs_final-jicg_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jicg_amnt = ls_bset-hwste.
              gs_final-jicg_per = ls_bset-kbetr.
            ENDIF.




********Non deductable
          ELSEIF ls_bset-kschl = 'JIIN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jiin_amnt = ls_bset-hwste * -1.
              gs_final-jiin_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jiin_amnt = ls_bset-hwste.
              gs_final-jiin_per = ls_bset-kbetr.
            ENDIF.

*          gs_final-non_ded_per_f = gs_final-jiin_per.

          ELSEIF ls_bset-kschl = 'JISN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jisn_amnt = ls_bset-hwste * -1.
              gs_final-jisn_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jisn_amnt = ls_bset-hwste.
              gs_final-jisn_per = ls_bset-kbetr.
            ENDIF.



          ELSEIF ls_bset-kschl = 'JICN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jicn_amnt = ls_bset-hwste * -1.
              gs_final-jicn_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jicn_amnt = ls_bset-hwste.
              gs_final-jicn_per = ls_bset-kbetr.
            ENDIF.

*******RCM
          ELSEIF ls_bset-kschl = 'JIIR'.
*          ELSEIF ls_bset-kschl = 'ZIRI'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-ziri_amnt = ls_bset-hwste * -1.
              gs_final-ziri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-ziri_amnt = ls_bset-hwste.
              gs_final-ziri_per = ls_bset-kbetr.
            ENDIF.

*          gs_final-rcm_per_f =  gs_final-jiir_per.
          ELSEIF ls_bset-kschl = 'JISR'.
*          ELSEIF ls_bset-kschl = 'ZSRI'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zsri_amnt = ls_bset-hwste * -1.
              gs_final-zsri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zsri_amnt = ls_bset-hwste.
              gs_final-zsri_per = ls_bset-kbetr.
            ENDIF.


          ELSEIF ls_bset-kschl = 'JICR'.
*          ELSEIF ls_bset-kschl = 'ZCRI'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zcri_amnt = ls_bset-hwste * -1.
              gs_final-zcri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zcri_amnt = ls_bset-hwste.
              gs_final-zcri_per = ls_bset-kbetr.
            ENDIF.


******** NON Deductable RCM
          ELSEIF ls_bset-kschl = 'ZIRN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-ziri_amnt = ls_bset-hwste * -1.
              gs_final-ziri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-ziri_amnt = ls_bset-hwste.
              gs_final-ziri_per = ls_bset-kbetr.
            ENDIF.


          ELSEIF ls_bset-kschl = 'ZSRN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zsri_amnt = ls_bset-hwste * -1.
              gs_final-zsri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zsri_amnt = ls_bset-hwste.
              gs_final-zsri_per = ls_bset-kbetr.
            ENDIF.


          ELSEIF ls_bset-kschl = 'ZCRN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zcri_amnt = ls_bset-hwste * -1.
              gs_final-zcri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zcri_amnt = ls_bset-hwste.
              gs_final-zcri_per = ls_bset-kbetr.
            ENDIF.
          ENDIF.
****
****************rate per calculation
          gs_final-ded_per_sum = gs_final-jicg_per + gs_final-jisg_per.
          gs_final-non_ded_per_sum = gs_final-jicn_per + gs_final-jisn_per.
          gs_final-rcm_per_sum = gs_final-jicr_per + gs_final-jisr_per.


          IF gs_final-ded_per_sum IS NOT INITIAL.
            gs_final-ded_per_sum = gs_final-ded_per_sum / 10.
            gs_final-final_per = gs_final-ded_per_sum.

          ELSEIF gs_final-jiig_per IS NOT INITIAL.
            gs_final-final_per =  gs_final-jiig_per / 10.

          ELSEIF gs_final-non_ded_per_sum IS NOT INITIAL.
            gs_final-non_ded_per_sum = gs_final-non_ded_per_sum / 10.
            gs_final-final_per = gs_final-non_ded_per_sum.
          ELSEIF gs_final-jiin_per IS NOT INITIAL.
            gs_final-final_per = gs_final-jiin_per / 10.

          ELSEIF gs_final-rcm_per_sum IS NOT INITIAL.
            gs_final-rcm_per_sum = gs_final-rcm_per_sum / 10.
            gs_final-final_per = gs_final-rcm_per_sum.
          ELSEIF gs_final-jiir_per IS NOT INITIAL.
            gs_final-final_per = gs_final-jiir_per / 10.
          ENDIF.

        ENDLOOP.

      ENDIF.
    ELSE."added on 26.04.2018
      READ TABLE lt_bset  TRANSPORTING NO FIELDS WITH KEY belnr = lv_belnr
      gjahr = lv_gjahr
      txgrp = lv_txgrp .
      IF sy-subrc = 0.
        LOOP AT lt_bset INTO ls_bset FROM sy-tabix.
          IF ls_bset-belnr <> lv_belnr OR
          ls_bset-gjahr <> lv_gjahr OR
          ls_bset-txgrp <> lv_txgrp.
            EXIT.
          ENDIF.

          IF ls_bset-kschl = 'JMOP'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-excise_amnt = ls_bset-hwste * -1.       "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-excise_amnt = ls_bset-hwste.       "Deductable
            ENDIF.

          ELSEIF ls_bset-kschl = 'JMIP'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-excise_amnt_nd = ls_bset-hwste * -1.    " Non Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-excise_amnt_nd = ls_bset-hwste.    " Non Deductable
            ENDIF.


          ELSEIF ls_bset-kschl = 'JVRD'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-vat_amnt  = ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-vat_amnt  = ls_bset-hwste.        "Deductable
            ENDIF.


          ELSEIF ls_bset-kschl = 'JVRN'.                " Non Deductable
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-vat_amnt_nd  =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-vat_amnt_nd  =  ls_bset-hwste.
            ENDIF.



          ELSEIF ls_bset-kschl = 'JVCS'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-cst_amnt  =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-cst_amnt  =  ls_bset-hwste.
            ENDIF.


          ELSEIF ls_bset-kschl = 'JIMD'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-import_amnt   =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-import_amnt   =  ls_bset-hwste.
            ENDIF.


          ELSEIF ls_bset-kschl = 'JIMN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-import_non_ded   =  ls_bset-hwste * -1.        "Deductable
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-import_non_ded   =  ls_bset-hwste.
            ENDIF.

********************For GST Taxes*******************************

********deductable
          ELSEIF ls_bset-kschl = 'JIIG'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jiig_amnt = ls_bset-hwste * -1.
              gs_final-jiig_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jiig_amnt = ls_bset-hwste.
              gs_final-jiig_per = ls_bset-kbetr.
            ENDIF.

*          gs_final-ded_per_f = gs_final-jiig_per.

          ELSEIF ls_bset-kschl = 'JISG'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jisg_amnt = ls_bset-hwste * -1.
              gs_final-jisg_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jisg_amnt = ls_bset-hwste.
              gs_final-jisg_per = ls_bset-kbetr.
            ENDIF.



          ELSEIF ls_bset-kschl = 'JICG'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jicg_amnt = ls_bset-hwste * -1.
              gs_final-jicg_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jicg_amnt = ls_bset-hwste.
              gs_final-jicg_per = ls_bset-kbetr.
            ENDIF.




********Non deductable
          ELSEIF ls_bset-kschl = 'JIIN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jiin_amnt = ls_bset-hwste * -1.
              gs_final-jiin_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jiin_amnt = ls_bset-hwste.
              gs_final-jiin_per = ls_bset-kbetr.
            ENDIF.

*          gs_final-non_ded_per_f = gs_final-jiin_per.

          ELSEIF ls_bset-kschl = 'JISN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jisn_amnt = ls_bset-hwste * -1.
              gs_final-jisn_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jisn_amnt = ls_bset-hwste.
              gs_final-jisn_per = ls_bset-kbetr.
            ENDIF.



          ELSEIF ls_bset-kschl = 'JICN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-jicn_amnt = ls_bset-hwste * -1.
              gs_final-jicn_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-jicn_amnt = ls_bset-hwste.
              gs_final-jicn_per = ls_bset-kbetr.
            ENDIF.

*******RCM
          ELSEIF ls_bset-kschl = 'JIIR'.
*          ELSEIF ls_bset-kschl = 'ZIRI'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-ziri_amnt = ls_bset-hwste * -1.
              gs_final-ziri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-ziri_amnt = ls_bset-hwste.
              gs_final-ziri_per = ls_bset-kbetr.
            ENDIF.

*          gs_final-rcm_per_f =  gs_final-jiir_per.
          ELSEIF ls_bset-kschl = 'JISR'.
*          ELSEIF ls_bset-kschl = 'ZSRI'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zsri_amnt = ls_bset-hwste * -1.
              gs_final-zsri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zsri_amnt = ls_bset-hwste.
              gs_final-zsri_per = ls_bset-kbetr.
            ENDIF.


          ELSEIF ls_bset-kschl = 'JICR'.
*          ELSEIF ls_bset-kschl = 'ZCRI'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zcri_amnt = ls_bset-hwste * -1.
              gs_final-zcri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zcri_amnt = ls_bset-hwste.
              gs_final-zcri_per = ls_bset-kbetr.
            ENDIF.


******** NON Deductable RCM
          ELSEIF ls_bset-kschl = 'ZIRN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-ziri_amnt = ls_bset-hwste * -1.
              gs_final-ziri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-ziri_amnt = ls_bset-hwste.
              gs_final-ziri_per = ls_bset-kbetr.
            ENDIF.


          ELSEIF ls_bset-kschl = 'ZSRN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zsri_amnt = ls_bset-hwste * -1.
              gs_final-zsri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zsri_amnt = ls_bset-hwste.
              gs_final-zsri_per = ls_bset-kbetr.
            ENDIF.


          ELSEIF ls_bset-kschl = 'ZCRN'.
            IF <ls_rseg>-shkzg = 'H'.
              gs_final-zcri_amnt = ls_bset-hwste * -1.
              gs_final-zcri_per = ls_bset-kbetr * -1.
            ELSEIF <ls_rseg>-shkzg = 'S'.
              gs_final-zcri_amnt = ls_bset-hwste.
              gs_final-zcri_per = ls_bset-kbetr.
            ENDIF.
          ENDIF.
****
****************rate per calculation
          gs_final-ded_per_sum = gs_final-jicg_per + gs_final-jisg_per.
          gs_final-non_ded_per_sum = gs_final-jicn_per + gs_final-jisn_per.
          gs_final-rcm_per_sum = gs_final-jicr_per + gs_final-jisr_per.


          IF gs_final-ded_per_sum IS NOT INITIAL.
            gs_final-ded_per_sum = gs_final-ded_per_sum / 10.
            gs_final-final_per = gs_final-ded_per_sum.

          ELSEIF gs_final-jiig_per IS NOT INITIAL.
            gs_final-final_per =  gs_final-jiig_per / 10.

          ELSEIF gs_final-non_ded_per_sum IS NOT INITIAL.
            gs_final-non_ded_per_sum = gs_final-non_ded_per_sum / 10.
            gs_final-final_per = gs_final-non_ded_per_sum.
          ELSEIF gs_final-jiin_per IS NOT INITIAL.
            gs_final-final_per = gs_final-jiin_per / 10.

          ELSEIF gs_final-rcm_per_sum IS NOT INITIAL.
            gs_final-rcm_per_sum = gs_final-rcm_per_sum / 10.
            gs_final-final_per = gs_final-rcm_per_sum.
          ELSEIF gs_final-jiir_per IS NOT INITIAL.
            gs_final-final_per = gs_final-jiir_per / 10.
          ENDIF.

        ENDLOOP.
      ENDIF.
    ENDIF.

    gs_final-j_1bbranch = ls_bseg_1-bupla."added on 10.10.2018.
**************************************************************** AJ *******************Aakash j patel***********
    CASE ls_bset-mwskz.

        " REGULAR Cases
      WHEN 'B1' OR 'B2' OR 'B3' OR 'B4'
         OR 'C2' OR 'C3' OR 'C4'
         OR 'D1' OR 'D2' OR 'D3' OR 'D4'
         OR 'Q1' OR 'Q2' OR 'Q3' OR 'Q4'.
        gs_final-mwskz = 'REGULAR'.

        " RCM Cases
      WHEN 'K1' OR 'K2' OR 'K3' OR 'K4'
         OR 'M1' OR 'M2' OR 'M3' OR 'M4'
         OR 'N1' OR 'N2' OR 'N3' OR 'N4'
         OR 'P1' OR 'P2' OR 'P3' OR 'P4'.
        gs_final-mwskz = 'RCM'.

        " ND Cases
      WHEN 'E1' OR 'E2' OR 'E3' OR 'E4'
         OR 'G1' OR 'G2' OR 'G3' OR 'G4'
         OR 'U1' OR 'U2' OR 'U3' OR 'U4'.
        gs_final-mwskz = 'ND'.

        " Default Case
      WHEN OTHERS.
        gs_final-mwskz = ls_bset-mwskz.
    ENDCASE.

**************************************************************************************************************************

****END Of comment
    READ TABLE lt_bkpf ASSIGNING <fs_bkpf> WITH KEY belnr = gs_final-fi_doc.
    IF sy-subrc = 0.
      gs_final-xblnr = <fs_bkpf>-xblnr.
      gs_final-bktxt = <fs_bkpf>-bktxt.
      gs_final-xblnr_alt = <fs_bkpf>-xblnr_alt.
      gs_final-tot_gst = gs_final-jiig_amnt + gs_final-jicg_amnt + gs_final-jisg_amnt +
                         gs_final-jiin_amnt + gs_final-jicn_amnt + gs_final-jisn_amnt +
                         gs_final-ziri_amnt + gs_final-zcri_amnt + gs_final-zsri_amnt.

*    READ TABLE lt_bset ASSIGNING FIELD-SYMBOL(<ls_bset>) WITH KEY belnr = gs_final-fi_doc
*                                                                  gjahr = <ls_rseg>-gjahr
*                                                                  txgrp = lv_txgrp.
*    IF sy-subrc = 0.
*      gs_final-dmbtr = <ls_bset>-hwbas.
    ENDIF.

    CLEAR: lv_flag,lv_txgrp,lv_tabix.
    CLEAR ls_bset.  ""<<<<<<<<<<<<<<<<<
******************************loop for  total amount ***********************************
    APPEND gs_final TO gt_final.
    CLEAR: gs_final,ls_sakt,ls_rbco,ls_anlh.
  ENDLOOP.
****************************************************************************
  LOOP AT gt_final INTO gs_final.
    gs_final-lv_tt_amt = gs_final-dmbtr + gs_final-tot_gst.
    MODIFY gt_final FROM gs_final.
  ENDLOOP.
*****************************************************************************
  UNASSIGN <ls_rseg>.
  SORT gt_final BY belnr.
*********************************************************************
  IF gt_final[] IS NOT INITIAL.
    PERFORM field_cat.
    PERFORM alv_disp.
  ELSE.
    MESSAGE 'No Data Found' TYPE 'I'.
  ENDIF.
*&---------------------------------------------------------------------*
*& Form field_cat
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM field_cat .

  DATA: lv_counter TYPE i.
**************************************************************

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BUKRS'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Company Code'. "'COMPANY CODE'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'GSTIN'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Company GSTNO'. "'COMPANY GSTNO'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'J_1BBRANCH'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Business Place'.  "'Business Place
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'WERKS'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Plant'.  "'Plant
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'PLANT_NAME'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Plant Dec.'.  "'Plant Desc.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'MJAHR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Year'.  "'Material Doc Year
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'MWSKZ'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Invoice Type'.  "'INVOICETYPE
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BELNR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Invoice No.'. "'IV Document No
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BLART'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Documnet Type'. "'Document type
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'LTEXT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Document Dec.'. "'DOCUMENTTYPEDESC
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BUZEI'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Line No.'. "'LINENO
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'FI_DOC'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'FI Invocie No.'.    "FI Document No.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

*  lv_counter = lv_counter + 1.
*  gs_fieldcat-col_pos    = lv_counter.
*  gs_fieldcat-fieldname  = 'XBLNR_ALT'.
*  gs_fieldcat-tabname    = 'GT_FINAL'.
*  gs_fieldcat-seltext_l  = 'ODNNO'.    "ODNNO
*  gs_fieldcat-no_zero    = 'X'.
*  APPEND gs_fieldcat TO gt_fieldcat.
*  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'REFERENCE_INVOICE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Referance Invoice'.    "REFERENCE_INVOICE
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'REFERENCE_INVOICE_DATE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Referance Inoice Date'.    "REFERENCE_INVOICE_DATE
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'EBELN'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Order No.'.  "'order no
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'VEND_INV'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Bill No'. "'bill no.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'VEND_INV_DT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor Invoice Date'. "'Vendor Invoice date.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BUDAT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Posting Date'. "'Posting date
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'VENDOR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor Code'. "'Vendor code'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'V_NAME1'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor Name'. "'Vendor Name'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'VEN_GSTIN'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor GST No'. "'Vendor GSTIN'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'VEN_CLASS_DESC'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor Type'. "'Vendor Classification'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'REGIO'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor State Code'. "'Vendor Region'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BEZEI'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Vendor State Name'. "'Vendor Region Desc.'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'PURCHASETYPE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Purchase Type'. "'PURCHASETYPE
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'TYPE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Type'. "'type
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'DESCRIPTION'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Description'. "'DESCRIPTION
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'MEINS'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'UOM'. "'Base Unit of Measure UOM
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'MENGE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Quantity'. "'Quantity
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'RATE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Unit Cost'. "'UNIT COST
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.      "Amount in Local Currency
  gs_fieldcat-fieldname  = 'DMBTR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Amount LC'.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  "CSGTGLACC  SGSTGLACC IGSTGLACC

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.      "TDS Amount
  gs_fieldcat-fieldname  = 'WT_QBSHH'.   "wt_qbshh
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'TDS Amount'.
  gs_fieldcat-do_sum    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'UNPLAND_GST'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Unpland_cst'. "'unpland_cst
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

*  final_per
  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'FINAL_PER'.
  gs_fieldcat-tabname    = 'GT_FINAL'.    " Rate Per
  gs_fieldcat-seltext_l  = 'Rate'.
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'JIIG_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'CGST Amt'.    " JIIG
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'JICG_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'SGST Amt'.    " JICG
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'JISG_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'IGST Amt'.    " JISG
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'JIIN_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'RCM CGST Amt'.    " JIIN
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'JICN_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'RCM SGST Amt'.    " JICN
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'JISN_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'RCM IGST Amt'.    " JISN
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'ZIRI_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'NDC GST AMt'.    " ZIRI
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'ZCRI_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'NDS GST Amt'.    " ZCRI
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'ZSRI_AMNT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'NDI GST Amt'.    " ZSRI
*  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'TOT_GST'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Total GST'.
  gs_fieldcat-no_zero    = 'X'.
  gs_fieldcat-do_sum    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'lV_TT_AMT'. "lv_tt_amt
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'TT_amt '. "'TT_amt
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'HSN_CODE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'HSN Code'. "'HSN Code
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'TRN_NME'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'TRN_nme'. "'TRANSACTION CODE DEC.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'MATHS_COD'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Maths_COD'. "'MATHS CODE.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'TAX_CODE'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Tax code'. "'Tax Code
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'TAX_DESC'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Tax Desc.'. "'Tax Description
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'NPLNR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Network'. "'NETWORK
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'KTEXT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Network Name'. "'NETWORK NAME
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'VORNR'.  "vornr
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Activity'. "'ACTIVITY
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'LTXA1'. "ltxa1
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Activity Name'. "'ACTIVITY name
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'PS_PSP_PNR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'WBS Element '. "'WBSELEMENT
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.
*************************************
  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'POST1'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'WBS Element Name'. "'WBSELEMENT NAME
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'POSKI'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'POSID'. "'POSID
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'ANLN1'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Asset'. "' Asset
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'TXT50'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Asset dec.'. "' Asset dec.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.


  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'KTOGR'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Account Group'. "' Acc. Group
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'KTGRTX'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Account Group Dec.'. "' Acc. group dec.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

  lv_counter = lv_counter + 1.
  gs_fieldcat-col_pos    = lv_counter.
  gs_fieldcat-fieldname  = 'BKTXT'.
  gs_fieldcat-tabname    = 'GT_FINAL'.
  gs_fieldcat-seltext_l  = 'Documnet Header Text.'. "' Acc. group dec.
  gs_fieldcat-no_zero    = 'X'.
  APPEND gs_fieldcat TO gt_fieldcat.
  CLEAR gs_fieldcat.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form alv_disp
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM alv_disp .
  gs_layout-zebra                = 'X'.
  gs_layout-detail_popup         = 'X'.
  gs_layout-detail_initial_lines = 'X'.
  gs_layout-colwidth_optimize    = 'X'.

*
*CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
* EXPORTING
*   I_INTERFACE_CHECK                 = ' '
*   I_BYPASSING_BUFFER                = ' '
*   I_BUFFER_ACTIVE                   = ' '
*   I_CALLBACK_PROGRAM                = ' '
*   I_CALLBACK_PF_STATUS_SET          = ' '
*   I_CALLBACK_USER_COMMAND           = ' '
*   I_CALLBACK_TOP_OF_PAGE            = ' '
*   I_CALLBACK_HTML_TOP_OF_PAGE       = ' '
*   I_CALLBACK_HTML_END_OF_LIST       = ' '
*   I_STRUCTURE_NAME                  =
*   I_BACKGROUND_ID                   = ' '
*   I_GRID_TITLE                      =
*   I_GRID_SETTINGS                   =
*   IS_LAYOUT                         =
*   IT_FIELDCAT                       = gt_fieldcat
*   IT_EXCLUDING                      =
*   IT_SPECIAL_GROUPS                 =
*   IT_SORT                           =
*   IT_FILTER                         =
*   IS_SEL_HIDE                       =
*   I_DEFAULT                         = 'X'
*   I_SAVE                            = ' '
*   IS_VARIANT                        =
*   IT_EVENTS                         =
*   IT_EVENT_EXIT                     =
*   IS_PRINT                          =
*   IS_REPREP_ID                      =
*   I_SCREEN_START_COLUMN             = 0
*   I_SCREEN_START_LINE               = 0
*   I_SCREEN_END_COLUMN               = 0
*   I_SCREEN_END_LINE                 = 0
*   I_HTML_HEIGHT_TOP                 = 0
*   I_HTML_HEIGHT_END                 = 0
*   IT_ALV_GRAPHICS                   =
*   IT_HYPERLINK                      =
*   IT_ADD_FIELDCAT                   =
*   IT_EXCEPT_QINFO                   =
*   IR_SALV_FULLSCREEN_ADAPTER        =
*   O_PREVIOUS_SRAL_HANDLER           =
* IMPORTING
*   E_EXIT_CAUSED_BY_CALLER           =
*   ES_EXIT_CAUSED_BY_USER            =
*  TABLES
*    t_outtab                          = gt_final[]
* EXCEPTIONS
*   PROGRAM_ERROR                     = 1
*   OTHERS                            = 2
*          .
*IF sy-subrc <> 0.
* Implement suitable error handling here
*ENDIF.

  CALL FUNCTION 'REUSE_ALV_GRID_DISPLAY'
    EXPORTING
      i_default     = 'X'
      it_fieldcat   = gt_fieldcat
    TABLES
      t_outtab      = gt_final[]
    EXCEPTIONS
      program_error = 1
      OTHERS        = 2.

  IF sy-subrc <> 0.
    MESSAGE 'Error displaying ALV' TYPE 'E'.
  ENDIF.

ENDFORM.
*&---------------------------------------------------------------------*
*& Form get_tax_data
*&---------------------------------------------------------------------*
*& text
*&---------------------------------------------------------------------*
*& -->  p1        text
*& <--  p2        text
*&---------------------------------------------------------------------*
FORM get_tax_data .
  SORT lt_bseg_1[] BY awkey ebeln ebelp txgrp.
  READ TABLE lt_bseg_1 ASSIGNING <fs_bseg_1> WITH KEY awkey = ls_bseg-awkey
  gjahr = ls_bseg-gjahr
  ebeln = <ls_rseg>-ebeln
  ebelp = <ls_rseg>-ebelp
  txgrp = <ls_rseg>-buzei" added on 06.07.2018
  flag = abap_false.
  IF sy-subrc = 0.
    <fs_bseg_1>-flag = 'X'.
    gs_final-ktosl   = <fs_bseg_1>-ktosl.

    IF ls_rbkp-waers EQ 'INR'.
      gs_final-dmbtr   = gs_final-wrbtr.
    ELSE.
      READ TABLE lt_bseg_summ INTO ls_bseg_summ WITH KEY awkey = ls_bseg-awkey
      gjahr = ls_bseg-gjahr
      ebeln = <ls_rseg>-ebeln
      ebelp = <ls_rseg>-ebelp.
      IF sy-subrc = 0.
        IF <ls_rseg>-shkzg = 'H'.
          gs_final-dmbtr   = ls_bseg_summ-dmbtr * -1 ."<fs_bseg_1>-dmbtr * -1.
        ELSEIF <ls_rseg>-shkzg = 'S'.
          gs_final-dmbtr   = ls_bseg_summ-dmbtr."<fs_bseg_1>-dmbtr.
        ENDIF.
      ENDIF.
    ENDIF.

    lv_txgrp = <fs_bseg_1>-txgrp.
    lv_belnr = <fs_bseg_1>-belnr.
    lv_gjahr = <fs_bseg_1>-gjahr.

    gs_final-fi_doc   = <fs_bseg_1>-belnr.

    CLEAR gs_final1.
    READ TABLE gt_final INTO gs_final1 WITH KEY fi_doc = <fs_bseg_1>-belnr.
    IF gs_final1-with_tax IS INITIAL.


      CLEAR is_with.
      READ TABLE it_with INTO is_with WITH KEY bukrs = <fs_bseg_1>-bukrs
                                               belnr = <fs_bseg_1>-belnr
*                                             buzei = <fs_bseg_1>-buzei
                                               gjahr = <fs_bseg_1>-gjahr.
      IF sy-subrc = 0.
        gs_final-with_tax = is_with-wt_qbshh.
      ELSE.
        READ TABLE lt_bseg_1 INTO DATA(ls_bseg_t) WITH KEY bukrs = <fs_bseg_1>-bukrs
              belnr = <fs_bseg_1>-belnr
              gjahr = <fs_bseg_1>-gjahr
              ktosl = 'WIT'.
        IF sy-subrc = 0.
          gs_final-with_tax = ls_bseg_t-wrbtr.
        ENDIF.
      ENDIF.
    ENDIF.
    IF gs_final1-vend_amt IS INITIAL.
      CLEAR ls_bseg_1.
      READ TABLE lt_bseg_1 INTO ls_bseg_1 WITH KEY belnr = gs_final-fi_doc
      awkey = ls_bseg-awkey
      gjahr = ls_bseg-gjahr
      koart = 'K'.
      IF sy-subrc = 0.
        IF <ls_rseg>-shkzg = 'S'.
          gs_final-vend_amt = ls_bseg_1-dmbtr.
        ELSEIF <ls_rseg>-shkzg = 'H'.
          gs_final-vend_amt = ( ls_bseg_1-dmbtr ) * -1.
        ENDIF.
      ENDIF.
    ENDIF.


    gs_final-prctr = <fs_bseg_1>-prctr.
    gs_final-busi_area = <fs_bseg_1>-gsber.
    lv_tabix = sy-tabix.
  ELSEIF gs_final-fi_doc IS INITIAL.              " Added on 10_08_2017
    CLEAR ls_bseg_2.
*      READ TABLE lt_bseg_2 INTO ls_bseg_2 WITH KEY  belnr_n = <ls_rseg>-belnr
*                                                    gjahr = <ls_rseg>-gjahr
*                                                    ebeln = <ls_rseg>-ebeln
*                                                    ebelp = <ls_rseg>-ebelp.
*      IF sy-subrc = 0.
*        gs_final-fi_doc     = ls_bseg_2-belnr.
*        gs_final-prctr      = ls_bseg_2-prctr.
*        gs_final-busi_area  = ls_bseg_2-gsber.
*      ENDIF.

    SORT lt_bseg_2 BY belnr_n gjahr ebeln ebelp txgrp.
    READ TABLE lt_bseg_2 ASSIGNING FIELD-SYMBOL(<ls_bseg_2>) WITH KEY  belnr_n = <ls_rseg>-belnr
    gjahr = <ls_rseg>-gjahr
    ebeln = <ls_rseg>-ebeln
    ebelp = <ls_rseg>-ebelp
    flag  = abap_false.
    IF sy-subrc = 0.
      <ls_bseg_2>-flag = 'X'.
      gs_final-fi_doc     = <ls_bseg_2>-belnr.
      gs_final-prctr      = <ls_bseg_2>-prctr.
      gs_final-busi_area  = <ls_bseg_2>-gsber.


      IF ls_rbkp-waers EQ 'INR'.
        gs_final-dmbtr   = gs_final-wrbtr.
      ELSE.
        READ TABLE lt_bseg_summ INTO ls_bseg_summ WITH KEY awkey = <ls_bseg_2>-awkey
        gjahr = <ls_bseg_2>-gjahr
        ebeln = <ls_rseg>-ebeln
        ebelp = <ls_rseg>-ebelp.
        IF sy-subrc = 0.
          IF <ls_rseg>-shkzg = 'H'.
            gs_final-dmbtr   = ls_bseg_summ-dmbtr * -1 .
          ELSEIF <ls_rseg>-shkzg = 'S'.
            gs_final-dmbtr   = ls_bseg_summ-dmbtr.
          ENDIF.
        ENDIF.
      ENDIF.

      lv_txgrp = <ls_bseg_2>-txgrp.
      lv_belnr = <ls_bseg_2>-belnr.
      lv_gjahr = <ls_bseg_2>-gjahr.

    ENDIF.
  ENDIF.
ENDFORM.
